"use strict";const e=require("../../common/vendor.js"),o={data:()=>({tempFilePath:"",progress:0,currentRate:30,adVideo:null,item:{},isSave:!1,isStart:!1,isDownLoad:!1,showLoading:!0}),onLoad(o){const s=e.index.getFileSystemManager();let t=wx.env.USER_DATA_PATH;if(s.readdir({dirPath:t,success(e){console.log(e),e.files.forEach((e=>{console.log(e),s.unlinkSync(t+"/"+e)}))},fail(e){console.log(e)},complete(){console.log("complete")}}),s.getSavedFileList({success:e=>{console.log(e),e.fileList.forEach((e=>{wx.removeSavedFile({filePath:e.filePath})}))}}),e.index.authorize({scope:"scope.writePhotosAlbum",success:()=>{console.log("success")},fail:()=>{e.index.openSetting({success:e=>{console.log(e)}})}}),console.log(o),this.item=o,"1"==o.isAd)this.createAd(),this.startDown();else{this.startDown();const o=setInterval((()=>{this.isDownLoad&&e.index.saveVideoToPhotosAlbum({filePath:this.tempFilePath,success:s=>{console.log(s,"success"),this.isSave=!0,this.isDownLoad=!1,e.index.hideLoading(),e.index.showToast({title:"已保存到相册"}),clearInterval(o),setTimeout((()=>{e.index.navigateBack()}),1e3)}})}),3e3)}},methods:{startDown(){this.isStart=!0;(new Date).valueOf();wx.env.USER_DATA_PATH;const o=e.index.downloadFile({url:this.item.url,timeout:18e5,success:e=>{200===e.statusCode&&(console.log("下载成功"),this.currentRate=100,this.tempFilePath=e.tempFilePath,this.isDownLoad=!0)},fail:o=>{console.log(o),this.showLoading=!1,e.index.hideLoading(),e.index.showModal({title:"下载提示",content:o,success:o=>{o.confirm?(e.index.setClipboardData({data:this.item.url,success:o=>{e.index.showToast({title:"复制成功"})},complete:e=>{console.log(e)}}),e.index.navigateBack()):o.cancel&&(console.log("用户点击取消"),e.index.navigateBack())}})}}),s=setInterval((()=>{this.currentRate>0&&clearInterval(s),o.onProgressUpdate((e=>{this.currentRate=e.progress}))}),1e3)},createAd(){e.index.createRewardedVideoAd&&(this.adVideo=e.index.createRewardedVideoAd({adUnitId:"adunit-e2d1bf46158bf61e"}),this.adVideo.onLoad((()=>{console.log("激励视频 广告加载成功 load")})),this.adVideo.onError((e=>{console.log("onError event emit",e)})),this.adVideo.onClose((o=>{if(console.log("close",o),o&&o.isEnded){this.adVideo.offClose();const o=setInterval((()=>{this.isDownLoad&&(e.index.showLoading({title:"保存中"}),e.index.saveVideoToPhotosAlbum({filePath:this.tempFilePath,success:s=>{console.log(s,"success"),this.isSave=!0,this.isDownLoad=!1,e.index.hideLoading(),e.index.showToast({title:"已保存到相册"}),clearInterval(o),e.index.navigateBack()}}))}),1e4)}else e.index.showToast({title:"未看完视频，无法下载"}),setTimeout((()=>{e.index.navigateBack()}),1e3)}))),this.adVideo&&this.adVideo.show().then((()=>{})).catch((o=>{console.log(o),this.adVideo.load().then((()=>{this.adVideo.show()})).catch((o=>{console.log("激励视频 广告显示失败",o);const s=setInterval((()=>{console.log(this.isDownLoad),this.isDownLoad&&(clearInterval(s),e.index.saveVideoToPhotosAlbum({filePath:this.tempFilePath,success:o=>{console.log(o,"success"),this.isSave=!0,e.index.showToast({title:"已保存到相册"}),clearInterval(s),setTimeout((()=>{e.index.navigateBack()}),1e3)}}))}),1e3)}))}))}}};if(!Array){(e.resolveComponent("u-line-progress")+e.resolveComponent("u-popup"))()}Math||((()=>"../../uni_modules/uview-plus/components/u-line-progress/u-line-progress.js")+(()=>"../../uni_modules/uview-plus/components/u-popup/u-popup.js"))();const s=e._export_sfc(o,[["render",function(o,s,t,i,n,a){return{a:e.p({percentage:n.currentRate,activeColor:"#ff0000"}),b:e.p({show:!0,mode:"center"})}}]]);wx.createPage(s);
